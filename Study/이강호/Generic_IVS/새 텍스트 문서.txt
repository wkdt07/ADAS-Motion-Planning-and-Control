function steering_angle = follow_path(Local_Waypoints, Ego_yaw, Ego_Global_X, Ego_Global_Y)
% Local_Waypoints : Nx2 [x, y] 차량 기준 로컬 경로
% Ego 정보는 사용되지 않음 (향후 개선을 위한 placeholder)

persistent stopped

% 초기화
if isempty(stopped)
    stopped = false;
end

% 파라미터
L = 4.0;               % 휠베이스
epsilon = 1e-3;        % 분모 안정성 보정
reach_thresh = 1.0;    % 도달 조건

% 유효한 경로가 없는 경우
% 우린 경로가 필요가 없음.
% Waypoint 도달 전에 다음 waypoint 값이 들어오는 상황.
if isempty(Local_Waypoints) || size(Local_Waypoints, 1) < 1
    steering_angle = 0;
    return;
end

% 첫 번째 로컬 경로 점을 목표로 사용
target = Local_Waypoints(1, :);
x_local = target(1);
y_local = target(2);

% 목표까지 거리
dist = sqrt(x_local^2 + y_local^2);

% 도달 조건 만족 시 정지
if dist < reach_thresh
    stopped = true;
    steering_angle = 0;
    return;
end

% Pure Pursuit 조향각 계산
denominator = x_local^2 + y_local^2 + epsilon;
steering_angle = atan2(2 * L * y_local, denominator);

end